<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レシピ予測 - エスプレッソレシピ管理システム</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- ヘッダー -->
    <div th:replace="fragments/header :: siteHeader"></div>

    <!-- メインコンテンツ -->
    <div class="main-content">
        <h1>レシピ予測</h1>
        <p class="lead">天候と気温に基づいて、最適なエスプレッソレシピを予測します</p>
        
        <!-- 予測フォーム -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>予測条件を入力</h2>
                <button type="button" id="getWeatherBtn" class="btn btn-outline-secondary" onclick="getCurrentWeather()">
                    <i class="weather-icon">🌤️</i> 天気取得
                </button>
            </div>
            <form id="predictForm">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="bean_name">コーヒー豆 *</label>
                        <select id="bean_name" name="bean_name" class="form-control" required>
                            <option value="">コーヒー豆を選択</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="days_passed">経過日数 *</label>
                        <input type="number" id="days_passed" name="days_passed" class="form-control" step="1" required>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="date">日付 *</label>
                        <input type="date" id="date" name="date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="weather">天候 *</label>
                        <select id="weather" name="weather" class="form-control" required>
                            <option value="">天候を選択</option>
                            <option value="晴れ">晴れ</option>
                            <option value="曇り">曇り</option>
                            <option value="雨">雨</option>
                            <option value="雪">雪</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="temperature">気温 (°C) *</label>
                        <input type="number" id="temperature" name="temperature" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="humidity">湿度 (%) *</label>
                        <input type="number" id="humidity" name="humidity" class="form-control" step="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <div id="weatherStatus" class="weather-status" style="display: none;">
                        <span class="weather-info"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">予測実行</button>
            </form>
        </div>

        <!-- 予測結果 -->
        <div class="card" id="predictionResult" style="display: none;">
            <h2>予測結果</h2>
            <div id="predictionContent"></div>
        </div>

        <!-- 時系列グラフ -->
        <div class="card" id="historyGraph" style="display: none;">
            <h2>過去1年のレシピ履歴</h2>
            <div class="grid grid-2">
                <div>
                    <h3>抽出時間の推移</h3>
                    <canvas id="extractionTimeChart" width="400" height="200"></canvas>
                </div>
                <div>
                    <h3>グラム数の推移</h3>
                    <canvas id="gramChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h3>メッシュ数の推移</h3>
                <canvas id="meshChart" width="800" height="200"></canvas>
            </div>
        </div>

        <!-- 統計情報 -->
        <div class="grid grid-3">
            <div class="card">
                <h3>天候別レシピ数</h3>
                <div id="weatherStats" class="loading">読み込み中...</div>
            </div>
            <div class="card">
                <h3>気温分布</h3>
                <div id="temperatureStats" class="loading">読み込み中...</div>
            </div>
            <div class="card">
                <h3>人気の抽出条件</h3>
                <div id="popularConditions" class="loading">読み込み中...</div>
            </div>
        </div>

        <!-- 最近の予測履歴 -->
        <div class="card">
            <h2>最近の予測履歴</h2>
            <div id="predictionHistory" class="loading">読み込み中...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/app.js}"></script>
    <script>
        let predictionHistory = [];
        let historyCharts = {};

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadUserBeans();
                setupEventListeners();
                setDefaultDate();
                loadStatistics();
                loadPredictionHistory();
            } catch (error) {
                console.error('Prediction page loading failed:', error);
                Utils.showAlert('予測ページの読み込みに失敗しました', 'danger');
            }
        });

        function setupEventListeners() {
            // フォーム送信イベント
            const predictForm = document.getElementById('predictForm');
            predictForm.addEventListener('submit', handlePredictionSubmit);
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // 天気API取得機能（無料版OpenWeatherMap API）
        async function getCurrentWeather() {
            const weatherBtn = document.getElementById('getWeatherBtn');
            const weatherStatus = document.getElementById('weatherStatus');
            const weatherInfo = weatherStatus.querySelector('.weather-info');
            
            // ボタンを無効化してローディング状態に
            weatherBtn.disabled = true;
            weatherBtn.innerHTML = '<i class="weather-icon">⏳</i> 取得中...';
            weatherStatus.style.display = 'block';
            weatherInfo.innerHTML = '京都の天気を取得中...';
            weatherInfo.className = 'weather-info loading';
            
            try {
                console.log('Starting weather API request...');
                const response = await fetch('http://localhost:8081/current-weather');
                console.log('API Response status:', response.status);
                console.log('API Response headers:', response.headers);
                console.log('Response OK:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                
                let weatherData;
                try {
                    weatherData = JSON.parse(responseText);
                    console.log('Parsed weather data:', weatherData);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(`JSON解析エラー: ${parseError.message}`);
                }
                
                console.log('Temperature check:', weatherData?.temperature, typeof weatherData?.temperature);
                console.log('Humidity check:', weatherData?.humidity, typeof weatherData?.humidity);
                
                if (weatherData && weatherData.temperature !== undefined && weatherData.humidity !== undefined) {
                    // 気温と湿度をフォームに設定
                    document.getElementById('temperature').value = Math.round(weatherData.temperature * 10) / 10;
                    document.getElementById('humidity').value = Math.round(weatherData.humidity);
                    
                    // 天候も自動設定（簡易的な判定）
                    const weatherSelect = document.getElementById('weather');
                    if (weatherData.weather) {
                        // APIから天候情報がある場合はそれを使用
                        const weatherMap = {
                            'Clear': '晴れ',
                            'Clouds': '曇り',
                            'Rain': '雨',
                            'Snow': '雪',
                            'Thunderstorm': '雨',
                            'Drizzle': '雨',
                            'Mist': '曇り',
                            'Fog': '曇り'
                        };
                        const japaneseWeather = weatherMap[weatherData.weather] || '晴れ';
                        weatherSelect.value = japaneseWeather;
                    }
                    
                    // 成功メッセージ
                    const location = weatherData.location || '京都';
                    const description = weatherData.description || '';
                    weatherInfo.innerHTML = `✅ 取得完了: ${weatherData.temperature}°C, 湿度${weatherData.humidity}% (${location}) ${description}`;
                    weatherInfo.className = 'weather-info success';
                    
                    // 3秒後にメッセージを非表示
                    setTimeout(() => {
                        weatherStatus.style.display = 'none';
                    }, 3000);
                    
                } else {
                    console.error('Invalid weather data format:', weatherData);
                    throw new Error(`天気データの形式が正しくありません。temperature: ${weatherData?.temperature}, humidity: ${weatherData?.humidity}`);
                }
                
            } catch (error) {
                console.error('天気取得エラー:', error);
                weatherInfo.innerHTML = `❌ 天気取得に失敗しました: ${error.message}`;
                weatherInfo.className = 'weather-info error';
                
                // 5秒後にメッセージを非表示
                setTimeout(() => {
                    weatherStatus.style.display = 'none';
                }, 5000);
            } finally {
                // ボタンを元に戻す
                weatherBtn.disabled = false;
                weatherBtn.innerHTML = '<i class="weather-icon">🌤️</i> 天気取得';
            }
        }


        async function loadUserBeans() {
            try {
                const beans = await ApiService.get('/predict/user-beans');
                if (beans && beans.length > 0) {
                    populateBeanSelect(beans);
                } else {
                    // 豆が登録されていない場合
                    const beanSelect = document.getElementById('bean_name');
                    
                    beanSelect.innerHTML = '<option value="">コーヒー豆が登録されていません</option>';
                    
                    Utils.showAlert('登録されているコーヒー豆がありません。先に豆を登録してください。', 'warning');
                }
            } catch (error) {
                console.error('Failed to load user beans:', error);
                Utils.showAlert('コーヒー豆の読み込みに失敗しました', 'danger');
            }
        }

        function populateBeanSelect(beans) {
            const beanSelect = document.getElementById('bean_name');
            
            // 既存のオプションをクリア（最初の「選択してください」以外）
            beanSelect.innerHTML = '<option value="">コーヒー豆を選択</option>';
            
            // 豆の選択肢を追加
            beans.forEach(bean => {
                const option = document.createElement('option');
                option.value = bean.name;
                option.textContent = `${bean.name} (${bean.origin})`;
                beanSelect.appendChild(option);
            });
        }

        async function handlePredictionSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            
            // バリデーション
            if (!FormHandler.validateRequired(form)) {
                Utils.showAlert('必須項目を入力してください', 'danger');
                return;
            }

            const formData = FormHandler.getFormData(form);
            


            try {
                console.log('Sending prediction request with data:', formData);
                const prediction = await ApiService.post('/predict/coffee', formData);
                
                displayPredictionResults(prediction, formData);
                addToPredictionHistory(formData, 1);
                
                // 過去のレシピ履歴を取得してグラフを表示
                await loadAndDisplayHistoryGraph(formData.bean_name);
            } catch (error) {
                console.error('Failed to get prediction:', error);
                Utils.showAlert('予測の取得に失敗しました', 'danger');
            }
        }

        function displayPredictionResults(prediction, conditions) {
            const resultDiv = document.getElementById('predictionResult');
            const contentDiv = document.getElementById('predictionContent');
            
            if (!prediction || prediction.error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h3>予測に失敗しました</h3>
                        <p>エラー: ${prediction ? prediction.error : '不明なエラー'}</p>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h3>予測完了！</h3>
                        <p>コーヒー豆: ${conditions.bean_name}</p>
                        <p>日付: ${conditions.date}, 天候: ${conditions.weather}</p>
                        <p>気温: ${conditions.temperature}°C, 湿度: ${conditions.humidity}%, 経過日数: ${conditions.days_passed}日</p>
                    </div>
                    <div class="grid grid-3">
                        <div class="card">
                            <h4>推奨グラム</h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.gram.toFixed(1)}g</p>
                            <small>抽出量</small>
                        </div>
                        <div class="card">
                            <h4>推奨メッシュ</h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.mesh.toFixed(1)}</p>
                            <small>粉の細かさ</small>
                        </div>
                        <div class="card">
                            <h4>抽出時間</h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.extraction_time.toFixed(1)}秒</p>
                            <small>推奨抽出時間</small>
                        </div>
                    </div>
                    <div class="card">
                        <h4>信頼度</h4>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${prediction.confidence * 100}%">
                                ${(prediction.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadAndDisplayHistoryGraph(beanName) {
            try {
                // 過去のレシピ履歴を取得
                const history = await ApiService.get(`/predict/bean-history?bean_name=${encodeURIComponent(beanName)}`);
                
                if (history && history.length > 0) {
                    displayHistoryGraphs(history);
                } else {
                    console.log('No history data available for this bean');
                }
            } catch (error) {
                console.error('Failed to load history data:', error);
            }
        }

        function displayHistoryGraphs(historyData) {
            // 既存のグラフを破棄
            Object.values(historyCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            historyCharts = {};

            // データを日付順にソート
            const sortedData = historyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // ラベル（日付）とデータを準備
            const labels = sortedData.map(item => {
                const date = new Date(item.date);
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });

            // 抽出時間のグラフ
            const extractionTimeCtx = document.getElementById('extractionTimeChart').getContext('2d');
            historyCharts.extractionTime = new Chart(extractionTimeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '抽出時間 (秒)',
                        data: sortedData.map(item => item.extraction_time),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '抽出時間の推移（過去1年）'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            },
                            ticks: {
                                maxTicksLimit: 12, // 月ごとに表示
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '秒'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // グラム数のグラフ
            const gramCtx = document.getElementById('gramChart').getContext('2d');
            historyCharts.gram = new Chart(gramCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'グラム数 (g)',
                        data: sortedData.map(item => item.gram),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'グラム数の推移（過去1年）'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'g'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // メッシュ数のグラフ
            const meshCtx = document.getElementById('meshChart').getContext('2d');
            historyCharts.mesh = new Chart(meshCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'メッシュ数',
                        data: sortedData.map(item => item.mesh),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'メッシュ数の推移（過去1年）'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'メッシュ'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // グラフエリアを表示
            document.getElementById('historyGraph').style.display = 'block';
            // document.getElementById('historyGraph').scrollIntoView({ behavior: 'smooth' }); // 自動スクロールを無効化
        }

        function loadStatistics() {
            // 統計情報を簡略化
            document.getElementById('weatherStats').innerHTML = `
                <div><strong>晴れ:</strong> 推奨</div>
                <div><strong>曇り:</strong> 推奨</div>
                <div><strong>雨:</strong> 注意</div>
                <div><strong>雪:</strong> 注意</div>
            `;
            
            document.getElementById('temperatureStats').innerHTML = `
                <div><strong>推奨範囲:</strong> 15-25°C</div>
                <div><strong>最適温度:</strong> 20°C</div>
                <div><strong>湿度:</strong> 50-70%</div>
            `;

            document.getElementById('popularConditions').innerHTML = `
                <div><strong>推奨グラム:</strong> 18-22g</div>
                <div><strong>推奨メッシュ:</strong> 15-20</div>
                <div><strong>抽出時間:</strong> 25-35秒</div>
            `;
        }

        function addToPredictionHistory(conditions, resultCount) {
            const history = {
                timestamp: new Date().toISOString(),
                conditions: conditions,
                resultCount: resultCount
            };
            
            predictionHistory.unshift(history);
            if (predictionHistory.length > 10) {
                predictionHistory = predictionHistory.slice(0, 10);
            }
            
            loadPredictionHistory();
        }

        function loadPredictionHistory() {
            const historyDiv = document.getElementById('predictionHistory');
            
            if (predictionHistory.length === 0) {
                historyDiv.innerHTML = '<p>予測履歴がありません</p>';
                return;
            }

            const historyHtml = predictionHistory.map(history => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="grid grid-2">
                        <div>
                            <strong>コーヒー豆:</strong> ${history.conditions.bean_name}
                        </div>
                        <div>
                            <strong>条件:</strong> ${history.conditions.weather}, ${history.conditions.temperature}°C
                        </div>
                    </div>
                    <div>
                        <strong>日付:</strong> ${history.conditions.date}
                    </div>
                    <small>${Utils.formatDate(history.timestamp)}</small>
                </div>
            `).join('');

            historyDiv.innerHTML = historyHtml;
        }
    </script>
</body>
</html>
