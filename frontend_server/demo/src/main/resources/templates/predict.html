<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ”äºˆæ¸¬ - ã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ãƒ¬ã‚·ãƒ”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div th:replace="fragments/header :: siteHeader"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <h1>ãƒ¬ã‚·ãƒ”äºˆæ¸¬</h1>
        <p class="lead">å¤©å€™ã¨æ°—æ¸©ã«åŸºã¥ã„ã¦ã€æœ€é©ãªã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ãƒ¬ã‚·ãƒ”ã‚’äºˆæ¸¬ã—ã¾ã™</p>
        
        <!-- äºˆæ¸¬ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>äºˆæ¸¬æ¡ä»¶ã‚’å…¥åŠ›</h2>
                <button type="button" id="getWeatherBtn" class="btn btn-outline-secondary" onclick="getCurrentWeather()">
                    <i class="weather-icon">ğŸŒ¤ï¸</i> å¤©æ°—å–å¾—
                </button>
            </div>
            <form id="predictForm">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="bean_name">ã‚³ãƒ¼ãƒ’ãƒ¼è±† *</label>
                        <select id="bean_name" name="bean_name" class="form-control" required>
                            <option value="">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã‚’é¸æŠ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="days_passed">çµŒéæ—¥æ•° *</label>
                        <input type="number" id="days_passed" name="days_passed" class="form-control" step="1" required>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="date">æ—¥ä»˜ *</label>
                        <input type="date" id="date" name="date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="weather">å¤©å€™ *</label>
                        <select id="weather" name="weather" class="form-control" required>
                            <option value="">å¤©å€™ã‚’é¸æŠ</option>
                            <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Š">æ›‡ã‚Š</option>
                            <option value="é›¨">é›¨</option>
                            <option value="é›ª">é›ª</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="temperature">æ°—æ¸© (Â°C) *</label>
                        <input type="number" id="temperature" name="temperature" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="humidity">æ¹¿åº¦ (%) *</label>
                        <input type="number" id="humidity" name="humidity" class="form-control" step="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <div id="weatherStatus" class="weather-status" style="display: none;">
                        <span class="weather-info"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">äºˆæ¸¬å®Ÿè¡Œ</button>
            </form>
        </div>

        <!-- äºˆæ¸¬çµæœ -->
        <div class="card" id="predictionResult" style="display: none;">
            <h2>äºˆæ¸¬çµæœ</h2>
            <div id="predictionContent"></div>
        </div>

        <!-- æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ• -->
        <div class="card" id="historyGraph" style="display: none;">
            <h2>éå»1å¹´ã®ãƒ¬ã‚·ãƒ”å±¥æ­´</h2>
            <div class="grid grid-2">
                <div>
                    <h3>æŠ½å‡ºæ™‚é–“ã®æ¨ç§»</h3>
                    <canvas id="extractionTimeChart" width="400" height="200"></canvas>
                </div>
                <div>
                    <h3>ã‚°ãƒ©ãƒ æ•°ã®æ¨ç§»</h3>
                    <canvas id="gramChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h3>ãƒ¡ãƒƒã‚·ãƒ¥æ•°ã®æ¨ç§»</h3>
                <canvas id="meshChart" width="800" height="200"></canvas>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="grid grid-3">
            <div class="card">
                <h3>å¤©å€™åˆ¥ãƒ¬ã‚·ãƒ”æ•°</h3>
                <div id="weatherStats" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="card">
                <h3>æ°—æ¸©åˆ†å¸ƒ</h3>
                <div id="temperatureStats" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="card">
                <h3>äººæ°—ã®æŠ½å‡ºæ¡ä»¶</h3>
                <div id="popularConditions" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- æœ€è¿‘ã®äºˆæ¸¬å±¥æ­´ -->
        <div class="card">
            <h2>æœ€è¿‘ã®äºˆæ¸¬å±¥æ­´</h2>
            <div id="predictionHistory" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/app.js}"></script>
    <script>
        let predictionHistory = [];
        let historyCharts = {};

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await loadUserBeans();
                setupEventListeners();
                setDefaultDate();
                loadStatistics();
                loadPredictionHistory();
            } catch (error) {
                console.error('Prediction page loading failed:', error);
                Utils.showAlert('äºˆæ¸¬ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        });

        function setupEventListeners() {
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            const predictForm = document.getElementById('predictForm');
            predictForm.addEventListener('submit', handlePredictionSubmit);
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // å¤©æ°—APIå–å¾—æ©Ÿèƒ½ï¼ˆç„¡æ–™ç‰ˆOpenWeatherMap APIï¼‰
        async function getCurrentWeather() {
            const weatherBtn = document.getElementById('getWeatherBtn');
            const weatherStatus = document.getElementById('weatherStatus');
            const weatherInfo = weatherStatus.querySelector('.weather-info');
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            weatherBtn.disabled = true;
            weatherBtn.innerHTML = '<i class="weather-icon">â³</i> å–å¾—ä¸­...';
            weatherStatus.style.display = 'block';
            weatherInfo.innerHTML = 'äº¬éƒ½ã®å¤©æ°—ã‚’å–å¾—ä¸­...';
            weatherInfo.className = 'weather-info loading';
            
            try {
                console.log('Starting weather API request...');
                const response = await fetch('http://localhost:8081/current-weather');
                console.log('API Response status:', response.status);
                console.log('API Response headers:', response.headers);
                console.log('Response OK:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                
                let weatherData;
                try {
                    weatherData = JSON.parse(responseText);
                    console.log('Parsed weather data:', weatherData);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${parseError.message}`);
                }
                
                console.log('Temperature check:', weatherData?.temperature, typeof weatherData?.temperature);
                console.log('Humidity check:', weatherData?.humidity, typeof weatherData?.humidity);
                
                if (weatherData && weatherData.temperature !== undefined && weatherData.humidity !== undefined) {
                    // æ°—æ¸©ã¨æ¹¿åº¦ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
                    document.getElementById('temperature').value = Math.round(weatherData.temperature * 10) / 10;
                    document.getElementById('humidity').value = Math.round(weatherData.humidity);
                    
                    // å¤©å€™ã‚‚è‡ªå‹•è¨­å®šï¼ˆç°¡æ˜“çš„ãªåˆ¤å®šï¼‰
                    const weatherSelect = document.getElementById('weather');
                    if (weatherData.weather) {
                        // APIã‹ã‚‰å¤©å€™æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                        const weatherMap = {
                            'Clear': 'æ™´ã‚Œ',
                            'Clouds': 'æ›‡ã‚Š',
                            'Rain': 'é›¨',
                            'Snow': 'é›ª',
                            'Thunderstorm': 'é›¨',
                            'Drizzle': 'é›¨',
                            'Mist': 'æ›‡ã‚Š',
                            'Fog': 'æ›‡ã‚Š'
                        };
                        const japaneseWeather = weatherMap[weatherData.weather] || 'æ™´ã‚Œ';
                        weatherSelect.value = japaneseWeather;
                    }
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const location = weatherData.location || 'äº¬éƒ½';
                    const description = weatherData.description || '';
                    weatherInfo.innerHTML = `âœ… å–å¾—å®Œäº†: ${weatherData.temperature}Â°C, æ¹¿åº¦${weatherData.humidity}% (${location}) ${description}`;
                    weatherInfo.className = 'weather-info success';
                    
                    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    setTimeout(() => {
                        weatherStatus.style.display = 'none';
                    }, 3000);
                    
                } else {
                    console.error('Invalid weather data format:', weatherData);
                    throw new Error(`å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚temperature: ${weatherData?.temperature}, humidity: ${weatherData?.humidity}`);
                }
                
            } catch (error) {
                console.error('å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                weatherInfo.innerHTML = `âŒ å¤©æ°—å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                weatherInfo.className = 'weather-info error';
                
                // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                setTimeout(() => {
                    weatherStatus.style.display = 'none';
                }, 5000);
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                weatherBtn.disabled = false;
                weatherBtn.innerHTML = '<i class="weather-icon">ğŸŒ¤ï¸</i> å¤©æ°—å–å¾—';
            }
        }


        async function loadUserBeans() {
            try {
                const beans = await ApiService.get('/predict/user-beans');
                if (beans && beans.length > 0) {
                    populateBeanSelect(beans);
                } else {
                    // è±†ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
                    const beanSelect = document.getElementById('bean_name');
                    
                    beanSelect.innerHTML = '<option value="">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</option>';
                    
                    Utils.showAlert('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ’ãƒ¼è±†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è±†ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚', 'warning');
                }
            } catch (error) {
                console.error('Failed to load user beans:', error);
                Utils.showAlert('ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        function populateBeanSelect(beans) {
            const beanSelect = document.getElementById('bean_name');
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ä»¥å¤–ï¼‰
            beanSelect.innerHTML = '<option value="">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã‚’é¸æŠ</option>';
            
            // è±†ã®é¸æŠè‚¢ã‚’è¿½åŠ 
            beans.forEach(bean => {
                const option = document.createElement('option');
                option.value = bean.name;
                option.textContent = `${bean.name} (${bean.origin})`;
                beanSelect.appendChild(option);
            });
        }

        async function handlePredictionSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!FormHandler.validateRequired(form)) {
                Utils.showAlert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
                return;
            }

            const formData = FormHandler.getFormData(form);
            


            try {
                console.log('Sending prediction request with data:', formData);
                const prediction = await ApiService.post('/predict/coffee', formData);
                
                displayPredictionResults(prediction, formData);
                addToPredictionHistory(formData, 1);
                
                // éå»ã®ãƒ¬ã‚·ãƒ”å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
                await loadAndDisplayHistoryGraph(formData.bean_name);
            } catch (error) {
                console.error('Failed to get prediction:', error);
                Utils.showAlert('äºˆæ¸¬ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        function displayPredictionResults(prediction, conditions) {
            const resultDiv = document.getElementById('predictionResult');
            const contentDiv = document.getElementById('predictionContent');
            
            if (!prediction || prediction.error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h3>äºˆæ¸¬ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                        <p>ã‚¨ãƒ©ãƒ¼: ${prediction ? prediction.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</p>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h3>äºˆæ¸¬å®Œäº†ï¼</h3>
                        <p>ã‚³ãƒ¼ãƒ’ãƒ¼è±†: ${conditions.bean_name}</p>
                        <p>æ—¥ä»˜: ${conditions.date}, å¤©å€™: ${conditions.weather}</p>
                        <p>æ°—æ¸©: ${conditions.temperature}Â°C, æ¹¿åº¦: ${conditions.humidity}%, çµŒéæ—¥æ•°: ${conditions.days_passed}æ—¥</p>
                    </div>
                    <div class="grid grid-3">
                        <div class="card">
                            <h4>æ¨å¥¨ã‚°ãƒ©ãƒ </h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.gram.toFixed(1)}g</p>
                            <small>æŠ½å‡ºé‡</small>
                        </div>
                        <div class="card">
                            <h4>æ¨å¥¨ãƒ¡ãƒƒã‚·ãƒ¥</h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.mesh.toFixed(1)}</p>
                            <small>ç²‰ã®ç´°ã‹ã•</small>
                        </div>
                        <div class="card">
                            <h4>æŠ½å‡ºæ™‚é–“</h4>
                            <p class="text-center" style="font-size: 2rem; font-weight: bold; color: #667eea;">${prediction.extraction_time.toFixed(1)}ç§’</p>
                            <small>æ¨å¥¨æŠ½å‡ºæ™‚é–“</small>
                        </div>
                    </div>
                    <div class="card">
                        <h4>ä¿¡é ¼åº¦</h4>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${prediction.confidence * 100}%">
                                ${(prediction.confidence * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadAndDisplayHistoryGraph(beanName) {
            try {
                // éå»ã®ãƒ¬ã‚·ãƒ”å±¥æ­´ã‚’å–å¾—
                const history = await ApiService.get(`/predict/bean-history?bean_name=${encodeURIComponent(beanName)}`);
                
                if (history && history.length > 0) {
                    displayHistoryGraphs(history);
                } else {
                    console.log('No history data available for this bean');
                }
            } catch (error) {
                console.error('Failed to load history data:', error);
            }
        }

        function displayHistoryGraphs(historyData) {
            // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
            Object.values(historyCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            historyCharts = {};

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedData = historyData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // ãƒ©ãƒ™ãƒ«ï¼ˆæ—¥ä»˜ï¼‰ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const labels = sortedData.map(item => {
                const date = new Date(item.date);
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });

            // æŠ½å‡ºæ™‚é–“ã®ã‚°ãƒ©ãƒ•
            const extractionTimeCtx = document.getElementById('extractionTimeChart').getContext('2d');
            historyCharts.extractionTime = new Chart(extractionTimeCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æŠ½å‡ºæ™‚é–“ (ç§’)',
                        data: sortedData.map(item => item.extraction_time),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æŠ½å‡ºæ™‚é–“ã®æ¨ç§»ï¼ˆéå»1å¹´ï¼‰'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥ä»˜'
                            },
                            ticks: {
                                maxTicksLimit: 12, // æœˆã”ã¨ã«è¡¨ç¤º
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ç§’'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // ã‚°ãƒ©ãƒ æ•°ã®ã‚°ãƒ©ãƒ•
            const gramCtx = document.getElementById('gramChart').getContext('2d');
            historyCharts.gram = new Chart(gramCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ã‚°ãƒ©ãƒ æ•° (g)',
                        data: sortedData.map(item => item.gram),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ã‚°ãƒ©ãƒ æ•°ã®æ¨ç§»ï¼ˆéå»1å¹´ï¼‰'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥ä»˜'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'g'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // ãƒ¡ãƒƒã‚·ãƒ¥æ•°ã®ã‚°ãƒ©ãƒ•
            const meshCtx = document.getElementById('meshChart').getContext('2d');
            historyCharts.mesh = new Chart(meshCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ãƒ¡ãƒƒã‚·ãƒ¥æ•°',
                        data: sortedData.map(item => item.mesh),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ãƒ¡ãƒƒã‚·ãƒ¥æ•°ã®æ¨ç§»ï¼ˆéå»1å¹´ï¼‰'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥ä»˜'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                maxRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ãƒ¡ãƒƒã‚·ãƒ¥'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            document.getElementById('historyGraph').style.display = 'block';
            // document.getElementById('historyGraph').scrollIntoView({ behavior: 'smooth' }); // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–
        }

        function loadStatistics() {
            // çµ±è¨ˆæƒ…å ±ã‚’ç°¡ç•¥åŒ–
            document.getElementById('weatherStats').innerHTML = `
                <div><strong>æ™´ã‚Œ:</strong> æ¨å¥¨</div>
                <div><strong>æ›‡ã‚Š:</strong> æ¨å¥¨</div>
                <div><strong>é›¨:</strong> æ³¨æ„</div>
                <div><strong>é›ª:</strong> æ³¨æ„</div>
            `;
            
            document.getElementById('temperatureStats').innerHTML = `
                <div><strong>æ¨å¥¨ç¯„å›²:</strong> 15-25Â°C</div>
                <div><strong>æœ€é©æ¸©åº¦:</strong> 20Â°C</div>
                <div><strong>æ¹¿åº¦:</strong> 50-70%</div>
            `;

            document.getElementById('popularConditions').innerHTML = `
                <div><strong>æ¨å¥¨ã‚°ãƒ©ãƒ :</strong> 18-22g</div>
                <div><strong>æ¨å¥¨ãƒ¡ãƒƒã‚·ãƒ¥:</strong> 15-20</div>
                <div><strong>æŠ½å‡ºæ™‚é–“:</strong> 25-35ç§’</div>
            `;
        }

        function addToPredictionHistory(conditions, resultCount) {
            const history = {
                timestamp: new Date().toISOString(),
                conditions: conditions,
                resultCount: resultCount
            };
            
            predictionHistory.unshift(history);
            if (predictionHistory.length > 10) {
                predictionHistory = predictionHistory.slice(0, 10);
            }
            
            loadPredictionHistory();
        }

        function loadPredictionHistory() {
            const historyDiv = document.getElementById('predictionHistory');
            
            if (predictionHistory.length === 0) {
                historyDiv.innerHTML = '<p>äºˆæ¸¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const historyHtml = predictionHistory.map(history => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="grid grid-2">
                        <div>
                            <strong>ã‚³ãƒ¼ãƒ’ãƒ¼è±†:</strong> ${history.conditions.bean_name}
                        </div>
                        <div>
                            <strong>æ¡ä»¶:</strong> ${history.conditions.weather}, ${history.conditions.temperature}Â°C
                        </div>
                    </div>
                    <div>
                        <strong>æ—¥ä»˜:</strong> ${history.conditions.date}
                    </div>
                    <small>${Utils.formatDate(history.timestamp)}</small>
                </div>
            `).join('');

            historyDiv.innerHTML = historyHtml;
        }
    </script>
</body>
</html>
