<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ”ç®¡ç† - ã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ãƒ¬ã‚·ãƒ”ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div th:replace="fragments/header :: siteHeader"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <h1>ãƒ¬ã‚·ãƒ”ç®¡ç†</h1>
        
        <!-- æ–°è¦ãƒ¬ã‚·ãƒ”ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>æ–°è¦ãƒ¬ã‚·ãƒ”ä½œæˆ
                    <button type="button" id="getWeatherBtn" class="btn btn-outline-secondary" onclick="getCurrentWeather()">
                        <i class="weather-icon">ğŸŒ¤ï¸</i> å¤©æ°—å–å¾—
                    </button>
                </h2>
            </div>
            <form id="recipeForm">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="date">æ—¥ä»˜ *</label>
                        <input type="date" id="date" name="date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="weather">å¤©å€™ *</label>
                        <select id="weather" name="weather" class="form-control" required>
                            <option value="">å¤©å€™ã‚’é¸æŠ</option>
                            <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Š">æ›‡ã‚Š</option>
                            <option value="é›¨">é›¨</option>
                            <option value="é›ª">é›ª</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="temperature">æ°—æ¸© (Â°C) *</label>
                        <input type="number" id="temperature" name="temperature" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="humidity">æ¹¿åº¦ (%) *</label>
                        <input type="number" id="humidity" name="humidity" class="form-control" min="0" max="100" required>
                    </div>
                </div>
                <div class="form-group">
                    <div id="weatherStatus" class="weather-status" style="display: none;">
                        <span class="weather-info"></span>
                    </div>
                </div>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="gram">æŠ½å‡ºé‡ (g) *</label>
                        <input type="number" id="gram" name="gram" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="mesh">æŒ½ãå…·åˆ *</label>
                        <input type="number" id="mesh" name="mesh" class="form-control" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="extraction_time">æŠ½å‡ºæ™‚é–“ (ç§’) *</label>
                        <input type="number" id="extraction_time" name="extraction_time" class="form-control" step="0.1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="beanId">ã‚³ãƒ¼ãƒ’ãƒ¼è±† *</label>
                    <select id="beanId" name="beanId" class="form-control" required>
                        <option value="">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">ãƒ¬ã‚·ãƒ”ä½œæˆ</button>
            </form>
        </div>

        <!-- ãƒ¬ã‚·ãƒ”ä¸€è¦§ -->
        <div class="card">
            <h2>ãƒ¬ã‚·ãƒ”ä¸€è¦§</h2>
            <div class="grid grid-2" style="margin-bottom: 1rem;">
                <div>
                    <label for="sortBy">ä¸¦ã³é †</label>
                    <select id="sortBy" class="form-control">
                        <option value="date">æ—¥ä»˜é †</option>
                        <option value="bean">ã‚³ãƒ¼ãƒ’ãƒ¼è±†é †</option>
                        <option value="weather">å¤©å€™é †</option>
                        <option value="temperature">æ°—æ¸©é †</option>
                    </select>
                </div>
                <div>
                    <label for="filterBean">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã§çµã‚Šè¾¼ã¿</label>
                    <select id="filterBean" class="form-control">
                        <option value="">ã™ã¹ã¦ã®è±†</option>
                    </select>
                </div>
            </div>
            <div id="recipeList" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script th:src="@{/js/app.js}"></script>
    <script>
        let recipes = [];
        let beans = [];
        let filteredRecipes = [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await Promise.all([loadBeans(), loadRecipes()]);
                setupEventListeners();
                populateBeanSelect();
                setDefaultDate();
            } catch (error) {
                console.error('Recipe page loading failed:', error);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        });

        // å¤©æ°—APIå–å¾—æ©Ÿèƒ½ï¼ˆpredictãƒšãƒ¼ã‚¸ã¨åŒä»•æ§˜ï¼‰
        async function getCurrentWeather() {
            const weatherBtn = document.getElementById('getWeatherBtn');
            const weatherStatus = document.getElementById('weatherStatus');
            const weatherInfo = weatherStatus.querySelector('.weather-info');
            
            weatherBtn.disabled = true;
            weatherBtn.innerHTML = '<i class="weather-icon">â³</i> å–å¾—ä¸­...';
            weatherStatus.style.display = 'block';
            weatherInfo.innerHTML = 'äº¬éƒ½ã®å¤©æ°—ã‚’å–å¾—ä¸­...';
            weatherInfo.className = 'weather-info loading';
            
            try {
                const response = await fetch('http://localhost:8081/current-weather');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const responseText = await response.text();
                let weatherData;
                try {
                    weatherData = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${parseError.message}`);
                }

                if (weatherData && weatherData.temperature !== undefined && weatherData.humidity !== undefined) {
                    document.getElementById('temperature').value = Math.round(weatherData.temperature * 10) / 10;
                    document.getElementById('humidity').value = Math.round(weatherData.humidity);

                    const weatherSelect = document.getElementById('weather');
                    if (weatherData.weather) {
                        const weatherMap = {
                            'Clear': 'æ™´ã‚Œ',
                            'Clouds': 'æ›‡ã‚Š',
                            'Rain': 'é›¨',
                            'Snow': 'é›ª',
                            'Thunderstorm': 'é›¨',
                            'Drizzle': 'é›¨',
                            'Mist': 'æ›‡ã‚Š',
                            'Fog': 'æ›‡ã‚Š'
                        };
                        const japaneseWeather = weatherMap[weatherData.weather] || 'æ™´ã‚Œ';
                        weatherSelect.value = japaneseWeather;
                    }

                    const location = weatherData.location || 'äº¬éƒ½';
                    const description = weatherData.description || '';
                    weatherInfo.innerHTML = `âœ… å–å¾—å®Œäº†: ${weatherData.temperature}Â°C, æ¹¿åº¦${weatherData.humidity}% (${location}) ${description}`;
                    weatherInfo.className = 'weather-info success';
                    setTimeout(() => { weatherStatus.style.display = 'none'; }, 3000);
                } else {
                    throw new Error(`å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚temperature: ${weatherData?.temperature}, humidity: ${weatherData?.humidity}`);
                }
            } catch (error) {
                console.error('å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                weatherInfo.innerHTML = `âŒ å¤©æ°—å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                weatherInfo.className = 'weather-info error';
                setTimeout(() => { weatherStatus.style.display = 'none'; }, 5000);
            } finally {
                weatherBtn.disabled = false;
                weatherBtn.innerHTML = '<i class="weather-icon">ğŸŒ¤ï¸</i> å¤©æ°—å–å¾—';
            }
        }

        function setupEventListeners() {
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            const recipeForm = document.getElementById('recipeForm');
            recipeForm.addEventListener('submit', handleRecipeSubmit);

            // ä¸¦ã³é †ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            const sortBy = document.getElementById('sortBy');
            const filterBean = document.getElementById('filterBean');
            sortBy.addEventListener('change', updateRecipeDisplay);
            filterBean.addEventListener('change', updateRecipeDisplay);
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        async function loadBeans() {
            try {
                beans = await ApiService.get('/beans');
            } catch (error) {
                console.error('Failed to load beans:', error);
                Utils.showAlert('ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        function populateBeanSelect() {
            // ã‚³ãƒ¼ãƒ’ãƒ¼è±†é¸æŠï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è±†ã®ã¿ï¼‰
            const beanSelect = document.getElementById('beanId');
            const filterBeanSelect = document.getElementById('filterBean');
            
            beanSelect.innerHTML = '<option value="">ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            filterBeanSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®è±†</option>';
            
            beans.forEach(bean => {
                // ãƒ¬ã‚·ãƒ”ä½œæˆç”¨ã®é¸æŠè‚¢
                const option = document.createElement('option');
                option.value = bean.id;
                option.textContent = `${bean.name} (${bean.fromLocation})`;
                beanSelect.appendChild(option);
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®é¸æŠè‚¢
                const filterOption = document.createElement('option');
                filterOption.value = bean.id;
                filterOption.textContent = bean.name;
                filterBeanSelect.appendChild(filterOption);
            });
        }

        async function loadRecipes() {
            try {
                recipes = await ApiService.get('/recipes');
                filteredRecipes = [...recipes];
                updateRecipeDisplay();
            } catch (error) {
                console.error('Failed to load recipes:', error);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        function updateRecipeDisplay() {
            const sortBy = document.getElementById('sortBy').value;
            const filterBeanId = document.getElementById('filterBean').value;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let recipesToShow = recipes;
            if (filterBeanId) {
                recipesToShow = recipes.filter(recipe => 
                    recipe.bean && recipe.bean.id == filterBeanId
                );
            }
            
            // ã‚½ãƒ¼ãƒˆ
            recipesToShow.sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        return new Date(b.date) - new Date(a.date);
                    case 'bean':
                        if (!a.bean || !b.bean) return 0;
                        return a.bean.name.localeCompare(b.bean.name);
                    case 'weather':
                        return a.weather.localeCompare(b.weather);
                    case 'temperature':
                        return b.temperature - a.temperature;
                    default:
                        return 0;
                }
            });
            
            filteredRecipes = recipesToShow;
            displayRecipes();
        }

        function displayRecipes() {
            const recipeListElement = document.getElementById('recipeList');
            
            if (filteredRecipes.length === 0) {
                recipeListElement.innerHTML = '<p>ãƒ¬ã‚·ãƒ”ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            const columns = [
                { key: 'date', header: 'æ—¥ä»˜', render: (value) => Utils.formatDate(value) },
                { key: 'weather', header: 'å¤©å€™' },
                { key: 'temperature', header: 'æ°—æ¸©', render: (value) => `${value}Â°C` },
                { key: 'humidity', header: 'æ¹¿åº¦', render: (value) => `${value}%` },
                { key: 'gram', header: 'æŠ½å‡ºé‡', render: (value) => `${value}g` },
                { key: 'mesh', header: 'æŒ½ãå…·åˆ' },
                { key: 'extraction_time', header: 'æŠ½å‡ºæ™‚é–“', render: (value) => `${value}ç§’` },
                { key: 'bean', header: 'ã‚³ãƒ¼ãƒ’ãƒ¼è±†', render: (value) => value ? `${value.name} (${value.fromLocation})` : 'ä¸æ˜' },
                { 
                    key: 'id', 
                    header: 'æ“ä½œ',
                    render: (value) => `
                        <button onclick="editRecipe(${value})" class="btn btn-secondary">ç·¨é›†</button>
                        <button onclick="deleteRecipe(${value})" class="btn btn-danger">å‰Šé™¤</button>
                    `
                }
            ];

            const table = DataTable.createTable(filteredRecipes, columns);
            recipeListElement.innerHTML = table;
        }

        async function handleRecipeSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!FormHandler.validateRequired(form)) {
                Utils.showAlert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
                return;
            }

            const formData = FormHandler.getFormData(form);
            
            // æ•°å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const temperature = parseFloat(formData.temperature);
            const humidity = parseInt(formData.humidity);
            const gram = parseFloat(formData.gram);
            const mesh = parseFloat(formData.mesh);
            const extraction_time = parseFloat(formData.extraction_time);

            if (isNaN(temperature) || isNaN(humidity) || isNaN(gram) || isNaN(mesh) || isNaN(extraction_time)) {
                Utils.showAlert('æ•°å€¤é …ç›®ã«æ­£ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
                return;
            }

            const recipeData = {
                date: formData.date,
                weather: formData.weather,
                temperature: temperature,
                humidity: humidity,
                gram: gram,
                mesh: mesh,
                extraction_time: extraction_time,
                bean: { id: parseInt(formData.beanId) }
            };

            try {
                await ApiService.post('/recipes', recipeData);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ', 'success');
                FormHandler.clearForm(form);
                setDefaultDate();
                await loadRecipes(); // ä¸€è¦§ã‚’æ›´æ–°
            } catch (error) {
                console.error('Failed to create recipe:', error);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        async function editRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) {
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
                return;
            }

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
            const modalContent = `
                <form id="editRecipeForm">
                    <input type="hidden" name="id" value="${recipe.id}">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="editDate">æ—¥ä»˜ *</label>
                            <input type="date" id="editDate" name="date" class="form-control" value="${recipe.date}" required>
                        </div>
                        <div class="form-group">
                            <label for="editWeather">å¤©å€™ *</label>
                            <select id="editWeather" name="weather" class="form-control" required>
                                <option value="æ™´ã‚Œ" ${recipe.weather === 'æ™´ã‚Œ' ? 'selected' : ''}>æ™´ã‚Œ</option>
                                <option value="æ›‡ã‚Š" ${recipe.weather === 'æ›‡ã‚Š' ? 'selected' : ''}>æ›‡ã‚Š</option>
                                <option value="é›¨" ${recipe.weather === 'é›¨' ? 'selected' : ''}>é›¨</option>
                                <option value="é›ª" ${recipe.weather === 'é›ª' ? 'selected' : ''}>é›ª</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="editTemperature">æ°—æ¸© (Â°C) *</label>
                            <input type="number" id="editTemperature" name="temperature" class="form-control" step="0.1" value="${recipe.temperature}" required>
                        </div>
                        <div class="form-group">
                            <label for="editHumidity">æ¹¿åº¦ (%) *</label>
                            <input type="number" id="editHumidity" name="humidity" class="form-control" min="0" max="100" value="${recipe.humidity}" required>
                        </div>
                    </div>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="editGram">æŠ½å‡ºé‡ (g) *</label>
                            <input type="number" id="editGram" name="gram" class="form-control" step="0.1" value="${recipe.gram}" required>
                        </div>
                        <div class="form-group">
                            <label for="editMesh">æŒ½ãå…·åˆ *</label>
                            <input type="number" id="editMesh" name="mesh" class="form-control" step="0.1" value="${recipe.mesh}" required>
                        </div>
                        <div class="form-group">
                            <label for="editExtractionTime">æŠ½å‡ºæ™‚é–“ (ç§’) *</label>
                            <input type="number" id="editExtractionTime" name="extraction_time" class="form-control" step="0.1" value="${recipe.extraction_time}" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ›´æ–°</button>
                </form>
            `;

            Modal.show('ãƒ¬ã‚·ãƒ”ç·¨é›†', modalContent);

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const editForm = document.getElementById('editRecipeForm');
            editForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const formData = FormHandler.getFormData(event.target);
                
                if (!FormHandler.validateRequired(event.target)) {
                    Utils.showAlert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger');
                    return;
                }

                const recipeData = {
                    date: formData.date,
                    weather: formData.weather,
                    temperature: parseFloat(formData.temperature),
                    humidity: parseInt(formData.humidity),
                    gram: parseFloat(formData.gram),
                    mesh: parseFloat(formData.mesh),
                    extraction_time: parseFloat(formData.extraction_time)
                };

                try {
                    await ApiService.put(`/recipes/${recipe.id}`, recipeData);
                    Utils.showAlert('ãƒ¬ã‚·ãƒ”ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
                    Modal.hide(document.querySelector('.modal'));
                    await loadRecipes(); // ä¸€è¦§ã‚’æ›´æ–°
                } catch (error) {
                    console.error('Failed to update recipe:', error);
                    Utils.showAlert('ãƒ¬ã‚·ãƒ”ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            });
        }

        async function deleteRecipe(recipeId) {
            if (!confirm('ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                await ApiService.delete(`/recipes/${recipeId}`);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ', 'success');
                await loadRecipes(); // ä¸€è¦§ã‚’æ›´æ–°
            } catch (error) {
                console.error('Failed to delete recipe:', error);
                Utils.showAlert('ãƒ¬ã‚·ãƒ”ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }
    </script>
</body>
</html>
