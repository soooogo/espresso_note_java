# デバッグツール

このフォルダには、データベースの永続化と重複挿入防止機能をテスト・デバッグするためのツールが含まれています。

## ファイル一覧

### 1. `debug_data_persistence.sh`
**包括的なデータ永続化デバッグスクリプト**

データベースの永続化機能を包括的にテストします。

#### 実行方法
```bash
cd debug
chmod +x debug_data_persistence.sh
./debug_data_persistence.sh
```

#### テスト内容
- **テスト1**: 初回起動（データベースが空の場合）
- **テスト2**: 2回目起動（既存データがある場合）
- **テスト3**: CSVデータ挿入テスト
- **テスト4**: 重複挿入防止テスト

#### 出力例
```
=== データ永続化デバッグスクリプト ===
📊 データベースの現在の状態を確認中...
✅ 初回起動テスト完了
✅ 2回目起動テスト完了
✅ CSVデータ挿入テスト完了
✅ 重複挿入防止テスト完了
```

### 2. `test_csv_duplicate_prevention.py`
**CSV重複挿入防止機能のテストスクリプト**

CSVデータの重複挿入防止機能を詳細にテストします。

#### 実行方法
```bash
cd debug
python3 test_csv_duplicate_prevention.py
```

#### テスト内容
- データベースの現在の状態確認
- CSVデータ挿入スクリプトの実行
- 重複チェック機能の動作確認
- 挿入結果の分析

#### 出力例
```
=== CSV重複挿入防止機能テスト ===
=== データベースの現在の状態 ===
ユーザー数: 3
コーヒー豆数: 8
レシピ数: 47

✅ 重複挿入防止機能が正常に動作しました（データが追加されませんでした）
```

## 使用方法

### 前提条件
1. Docker Composeサービスが起動していること
2. MySQLデータベースが利用可能であること
3. Spring Bootアプリケーションが起動していること

### 基本的な使用手順

1. **サービス起動**
   ```bash
   cd /Users/kurodasougo/java\ application
   docker-compose up -d
   ```

2. **デバッグ実行**
   ```bash
   cd debug
   ./debug_data_persistence.sh
   ```

3. **結果確認**
   - コンソール出力でテスト結果を確認
   - データベースの状態変化を確認
   - ログファイルで詳細な動作を確認

## トラブルシューティング

### よくある問題

#### 1. データベース接続エラー
```
❌ データベース接続エラー: Access denied for user 'demo_user'@'localhost'
```
**解決方法**: Docker Composeサービスが正しく起動しているか確認

#### 2. Spring Boot起動タイムアウト
```
❌ Spring Boot起動タイムアウト
```
**解決方法**: アプリケーションの起動完了を待つか、手動で起動を確認

#### 3. CSVファイルが見つからない
```
❌ 読み込めるCSVファイルが見つかりませんでした
```
**解決方法**: `backend_server/data/`フォルダにCSVファイルが存在するか確認

### ログの確認方法

#### Spring Bootログ
```bash
docker-compose logs springboot
```

#### Backendログ
```bash
docker-compose logs backend
```

#### MySQLログ
```bash
docker-compose logs mysql
```

## 期待される動作

### 正常な動作パターン

1. **初回起動時**
   - DataInitializerがサンプルデータを挿入
   - CSVデータ挿入スクリプトが新規データを挿入

2. **2回目以降の起動時**
   - DataInitializerが既存データを検出してスキップ
   - CSVデータ挿入スクリプトが重複を検出してスキップ

3. **重複チェック**
   - 既存データとの重複率を計算
   - 80%以上重複の場合は挿入をスキップ
   - 新規データのみを挿入

## カスタマイズ

### 重複率の閾値変更
`backend_server/insert_data.py`の以下の部分を変更：
```python
elif duplicate_rate > 80:  # この値を変更
```

### ログレベルの調整
各スクリプト内の`print`文を調整してログ出力を制御できます。

## 注意事項

- デバッグスクリプトは本番環境では使用しないでください
- テスト実行前にデータのバックアップを取ることを推奨します
- 大量のデータがある場合、テスト実行に時間がかかる場合があります
